# API Specification - Portun.app

**Date**: 2025-11-14
**Version**: 1.0

---

## Overview

### Base URLs
| Environment | REST API | Edge Functions | Storage |
|-------------|----------|----------------|---------|
| Production | `https://[project].supabase.co/rest/v1/` | `https://[project].supabase.co/functions/v1/` | `https://[project].supabase.co/storage/v1/` |

### Authentication
All requests require:
```
Authorization: Bearer <JWT_TOKEN>
apikey: <SUPABASE_ANON_KEY>
```

### Rate Limits
- REST API: 100 requests/minute per user
- Edge Functions: 60 calls/minute per user
- Storage uploads: 50 files/hour per user

---

## REST API Endpoints

Auto-generated by PostgREST from database schema.

### Visitor Records

**List visitor records**
```http
GET /visitor_records_uid
```
Query params:
- `host_uid=eq.{uuid}` - Filter by host
- `validity_end=gt.{timestamp}` - Only active
- `select=*,profile!host_uid(name)` - Include host name
- `order=created_at.desc` - Sort by newest
- `limit=20&offset=0` - Pagination

**Create visitor QR**
```http
POST /visitor_records_uid
Content-Type: application/json

{
  "host_uid": "550e8400-e29b-41d4-a716-446655440000",
  "record_uid": "VIS-1736961234567-X7K",
  "visitor_name": "John Doe",
  "visitor_phone": "+1234567890",
  "vehicle_info": "Toyota Camry ABC-123",
  "validity_end": "2025-01-15T23:59:59Z",
  "entries_allowed": 1
}
```

**Get single visitor**
```http
GET /visitor_records_uid?id=eq.{uuid}
```

**Update visitor**
```http
PATCH /visitor_records_uid?id=eq.{uuid}
Content-Type: application/json

{
  "validity_end": "2025-01-16T23:59:59Z"
}
```

**Delete visitor**
```http
DELETE /visitor_records_uid?id=eq.{uuid}
```

---

### Entry Logs

**List entry logs**
```http
GET /entry_logs
```
Query params:
- `visitor_uid=eq.{uuid}` - Filter by visitor
- `guard_uid=eq.{uuid}` - Filter by guard
- `entry_time=gte.{timestamp}` - Filter by date range
- `select=*,visitor_records_uid(visitor_name),profile!guard_uid(name)`

**Log entry**
```http
POST /entry_logs
Content-Type: application/json

{
  "visitor_uid": "550e8400-e29b-41d4-a716-446655440000",
  "guard_uid": "660e8400-e29b-41d4-a716-446655440000",
  "photo_url": "https://storage.../entry_photos/123.jpg",
  "notes": "Arrived with extra guest"
}
```

---

### Payment Receipts

**List receipts**
```http
GET /payment_receipts
```
Query params:
- `resident_uid=eq.{uuid}` - Filter by resident
- `community_id=eq.{uuid}` - Filter by community
- `status=eq.pending` - Filter by status
- `month=eq.2025-01` - Filter by month

**Upload receipt**
```http
POST /payment_receipts
Content-Type: application/json

{
  "resident_uid": "550e8400-e29b-41d4-a716-446655440000",
  "community_id": "770e8400-e29b-41d4-a716-446655440000",
  "month": "2025-01",
  "amount": 250.00,
  "receipt_url": "https://storage.../receipts/123.jpg",
  "receipt_hash": "sha256:abc123..."
}
```

**Verify/reject receipt**
```http
PATCH /payment_receipts?id=eq.{uuid}
Content-Type: application/json

{
  "status": "verified",
  "verified_by": "880e8400-e29b-41d4-a716-446655440000",
  "verified_at": "2025-01-15T10:30:00Z"
}
```

Or reject:
```json
{
  "status": "rejected",
  "verified_by": "880e8400-...",
  "verified_at": "2025-01-15T10:30:00Z",
  "rejection_reason": "Amount unclear - please reupload"
}
```

---

### Profile

**List users in community**
```http
GET /profile?community_id=eq.{uuid}
```

**Update profile**
```http
PATCH /profile?id=eq.{uuid}
Content-Type: application/json

{
  "name": "Maria Rodriguez",
  "phone": "+1234567890"
}
```

---

## Edge Functions

### validate-qr

Validates a QR code server-side.

**Endpoint**: `POST /functions/v1/validate-qr`

**Request**:
```json
{
  "record_uid": "VIS-12345-ABC",
  "guard_uid": "550e8400-e29b-41d4-a716-446655440000",
  "timestamp": "2025-01-15T14:30:00Z"
}
```

**Response (Valid)**:
```json
{
  "valid": true,
  "visitor": {
    "name": "John Doe",
    "host": "Maria Rodriguez",
    "vehicle": "Toyota Camry ABC-123",
    "validity_end": "2025-01-15T23:59:59Z",
    "entries_used": 0,
    "entries_allowed": 1
  }
}
```

**Response (Invalid)**:
```json
{
  "valid": false,
  "reason": "QR code expired"
}
```

Possible reasons:
- `QR code not found`
- `QR code expired`
- `Entry limit exceeded`
- `Visitor blacklisted`
- `Host account inactive`

---

### log-entry

Logs a visitor entry with atomic counter update.

**Endpoint**: `POST /functions/v1/log-entry`

**Request**:
```json
{
  "visitor_uid": "550e8400-e29b-41d4-a716-446655440000",
  "guard_uid": "660e8400-e29b-41d4-a716-446655440000",
  "photo_url": "https://storage.../entry_photos/123.jpg",
  "vehicle_photo_url": "https://storage.../vehicle_photos/123.jpg",
  "notes": "Guest arrived with extra visitor"
}
```

**Response**:
```json
{
  "success": true,
  "entry_id": "770e8400-e29b-41d4-a716-446655440000",
  "entries_used": 1,
  "notification_sent": true
}
```

**Side Effects**:
- Increments `entries_used` via database function
- Inserts record into `entry_logs`
- Sends push notification to host via OneSignal

---

### payment-notification

Sends notification when payment status changes.

**Endpoint**: `POST /functions/v1/payment-notification`

**Request** (internal trigger):
```json
{
  "receipt_id": "880e8400-e29b-41d4-a716-446655440000",
  "status": "verified",
  "resident_uid": "990e8400-e29b-41d4-a716-446655440000"
}
```

**Response**:
```json
{
  "success": true,
  "notification_sent": true
}
```

---

## External API Integrations

### OneSignal (Push Notifications)

**Send notification**:
```http
POST https://onesignal.com/api/v1/notifications
Authorization: Basic <ONESIGNAL_REST_API_KEY>
Content-Type: application/json

{
  "app_id": "<ONESIGNAL_APP_ID>",
  "include_player_ids": ["<device_token>"],
  "headings": { "en": "Visitor Arrived", "es": "Visitante Lleg√≥" },
  "contents": {
    "en": "Your visitor John Doe has arrived.",
    "es": "Tu visitante John Doe ha llegado."
  },
  "data": {
    "type": "visitor_arrival",
    "entry_log_id": "550e8400-..."
  }
}
```

---

### Shelly Cloud API (Gate Control)

**Open gate**:
```http
POST https://shelly-api-cloud.shelly.cloud/device/relay/control
Authorization: Bearer <SHELLY_AUTH_KEY>
Content-Type: application/json

{
  "id": "<SHELLY_DEVICE_ID>",
  "channel": 0,
  "turn": "on",
  "timer": 5
}
```

---

## Storage API

### Upload file
```http
POST /storage/v1/object/payment-receipts/{user_id}/{filename}
Authorization: Bearer <JWT_TOKEN>
Content-Type: image/jpeg

<binary image data>
```

### Get public URL
```http
GET /storage/v1/object/public/payment-receipts/{user_id}/{filename}
```

---

## Error Responses

All endpoints return consistent error format:

```json
{
  "error": {
    "code": "PGRST116",
    "message": "The result contains 0 rows",
    "details": null,
    "hint": null
  }
}
```

Common error codes:
- `401` - Unauthorized (invalid/expired token)
- `403` - Forbidden (RLS policy violation)
- `404` - Not found
- `409` - Conflict (unique constraint violation)
- `422` - Validation error
- `429` - Rate limit exceeded

---

*Document maintained by Portun.app Engineering Team*
